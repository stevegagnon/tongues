<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
</head>

<body>
  <button id="rendered-play-w">rendered-play-w</button>
  <button id="rendered-play-x">rendered-play-x</button>

  <script type="module">
    import song from './media/sonant-x-song.js';
    import render_x from './synth/sonant-x/render-x.js';
    import render_w from './synth/sonant-x/render-w.js';
    import convert from './synth/sonant-x/convert-x.js';

    const sampleRate = 44100;

    const play_w = document.getElementById('rendered-play-w');
    const play_x = document.getElementById('rendered-play-x');

    play_w.addEventListener('click', () => {
      const samples = render_w(convert(song, {removeMutedOsc: false}), sampleRate);

      const audioCtx = new AudioContext({ sampleRate });
      const myArrayBuffer = audioCtx.createBuffer(2, samples[0].length, sampleRate);

      let min = Infinity;
      let max = -Infinity;

      for (let ch = 0; ch < 2; ++ch) {
        const c = myArrayBuffer.getChannelData(ch);
        for (let i = 0; i < samples[ch].length; ++i) {
          const s = samples[ch][i];
          if (s < min) min = s;
          if (s > max) max = s;
          c[i] = s;
        }
      }

      console.log(min, max);
      
      const source = audioCtx.createBufferSource();
      source.buffer = myArrayBuffer;
      source.connect(audioCtx.destination);
      source.start();
    });

    play_x.addEventListener('click', () => {
      const s0 = convert(song);

      console.log(JSON.stringify(s0));
      
      const samples = render_x(s0, sampleRate);

      const audioCtx = new AudioContext({ sampleRate });
      const myArrayBuffer = audioCtx.createBuffer(2, samples[0].length, sampleRate);

      for (let ch = 0; ch < 2; ++ch) {
        const c = myArrayBuffer.getChannelData(ch);
        for (let i = 0; i < samples[ch].length; ++i) {
          c[i] = samples[ch][i];
        }
      }

      const source = audioCtx.createBufferSource();
      source.buffer = myArrayBuffer;
      source.connect(audioCtx.destination);
      source.start();
    });

  </script>
</body>

</html>